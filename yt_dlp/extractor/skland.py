import base64
import gzip
import hashlib
import hmac
import json
import time
from datetime import datetime
from .common import InfoExtractor, ExtractorError
from ..dependencies import Cryptodome
from ..utils import (
    traverse_obj, 
    str_or_none,
    int_or_none,
    random_uuidv4,
)


class SklandArticleIE(InfoExtractor):
    IE_NAME = 'skland:article'
    IE_DESC = '森空岛'
    _VALID_URL = r'https?://www\.skland\.com/article\?id=(?P<id>[0-9]+)'
    _TESTS = [{
        'url': 'https://www.skland.com/article?id=2944931',
        'info_dict': {
            'id': '2944931',
            'ext': 'mp4',
            'title': 'md5:.*',
        }
    }]

    
    def _real_extract(self, url):
        id = self._match_id(url)

        url = f'https://www.skland.com/article?id={id}'

        did = self._get_did_from_v4(url, id)

        auth = traverse_obj(self._call_api('/auth/refresh', id, did), {
            'time': ('timestamp', {str_or_none}),
            'token': ('data', 'token'),
        })

        info = self._call_api(f'/item?id={id}', id, did, auth)

        if not info.get("message") == 'OK':
            raise ExtractorError('asking for info returned nothing')

        meta = traverse_obj(info, ('data', {
            'title': ('item', 'title', {str.strip}),
            'desc': ("item", "textSlice", ..., "c", all, {lambda x: '\n'.join(x)}),
            'id': id,
            'uploader': ('user', 'nickname'),
            'timestamp': ("createdAtTs", {})
        }))

        entries = []

        idx = 1

        for video in traverse_obj(info, ('data', 'item', 'videoListSlice', any)):
            formats = []
            video_id = f'{id}-{idx}'
            idx += 1
            thumbnail = traverse_obj(video, ('cover', 'url'))
            for fmt in video.get('resolutions', {}):
                if fmt['format'] == 'm3u8':
                    tmp = self._extract_m3u8_formats(fmt['playURL'], video_id, m3u8_id='hls', fatal=False)
                    if not tmp:
                        continue
                    size_info = traverse_obj(fmt, ({
                        'height': 'height',
                        'width': 'width',
                        'filesize': ('size', {int_or_none}),
                        'duration': 'duration',
                    },)) | {'ext': 'mp4'}
                    for _m3u8_fmt in tmp:
                        formats.append(_m3u8_fmt | size_info)

            entries.append({
                'id': video_id,
                'thumbnail': thumbnail,
                'formats': formats
            })

        if len(entries) == 1:
            return entries[0] | meta

        return self.playlist_result(entries, id, multi_video=True, **meta)


    def _get_did_from_v4(self, url, id):
        def _uuid_to_ep(uuid): 
            if not Cryptodome.RSA:
                raise ExtractorError('pycryptodomex not found. Please install', expected=True)
            
            sm_pubkey = (
                "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCmxMNr7n8ZeT0tE1R9j/mPixoinPke"
                "M+k4VGIn/s0k7N5rJAfnZ0eMER+QhwFvshzo0LNmeUkpR8uIlU/GEVr8mN28sKmwd2gpy"
                "gqj0ePnBmOW4v0ZVwbSYK+izkhVFk2V/doLoMbWy6b+UnA8mkjvg0iYWRByfRsK2gdl7"
                "llqCwIDAQAB"
            )
            public_key = Cryptodome.RSA.import_key(base64.b64decode(sm_pubkey))
            cipher = Cryptodome.PKCS1_v1_5.new(public_key)
            text = cipher.encrypt(uuid.encode())

            return base64.b64encode(text).decode()
        
        uuid = random_uuidv4()
        
        timestamp = str(int(time.time()))

        postdata = json.dumps({
            "appId": "default",
            "organization": "UWXspnCCJN4sfYlNfqps",
            "ep": _uuid_to_ep(uuid),
            "data": self._create_v4_postdata(url, uuid, int(timestamp)),
            "os": "web",
            "encode": 5,
            "compress": 2
        }, separators=(',', ':')).encode()


        v4 = self._download_json(
            'https://fp-it.portal101.cn/deviceprofile/v4', id, 
            note='fetch did from v4', errnote='failed to call v4 api', 
            headers={
                'referer': 'https://www.skland.com/',
                'Content-Type': 'application/json;charset=utf-8',
            }, 
            data = postdata,
        )

        did =  traverse_obj(v4, ('detail', 'deviceId'))

        if did is None:
            raise ExtractorError('Can not fetch did from v4 api', expected=True)
        
        return 'B' + did


    def _call_api(self, path, id, did, auth={}):
        timestamp = auth.get('time') or str(int(time.time()))
        token = auth.get('token') or ''

        s = '/web/v1' + path.replace('?', '') + timestamp + json.dumps({
            "platform": "3",
            "timestamp": timestamp,
            "dId": did,
            "vName": "1.0.0"
        }, separators=(',', ':'))

        hex_s = hmac.new(token.encode(), s.encode(), hashlib.sha256).hexdigest()
        sign = hashlib.md5(hex_s.encode()).hexdigest() 

        headers = {
            'referer': 'https://www.skland.com/',
            'timestamp': timestamp,
            'vname': '1.0.0',
            'platform': 3,
            'did': did,
            'sign': sign, 
            'origin': 'https://www.skland.com/',
        }
        item = self._download_json('https://zonai.skland.com/web/v1' + path, id, headers=headers)

        return item


    def _create_v4_postdata(self, url, uuid, timestamp):
        def _get_smid():
            date = datetime.now().strftime("%Y%m%d%H%M%S")
            uid = random_uuidv4()
            cipher = date + hashlib.md5(uid.encode()).hexdigest() + '00'
            return cipher + hashlib.md5(('smsk_web_' + cipher)[:14].encode()).hexdigest()
        
        def _des_encrypt(key, data):
            data = str(data).encode('latin-1')
            data += b"\0" * (8 - len(data) % 8)

            cipher = Cryptodome.Cipher.DES.new(str(key).encode('latin-1'), Cryptodome.Cipher.DES.MODE_ECB).encrypt(data)

            return base64.b64encode(bytearray(cipher)).decode("utf-8")
        
        lookup = {
            "vw": "2mdeslu3",
            "pi": "acfs0xo4",
            "cf": "y95hjkoo",
            "ca": "r9924ab5",
            "qr": "fzj3kaeh",
            "py": "x9nzj1bp",
        }

        data = {
            "xx": "Xoz/PL65pzA=",
            "dp": "gc5v+9XJyOQ/mXat2QddjRRT1uoQrObF",
            "pj": "qeDGcpUpK4Y=",
            "gm": "HvYa39S0OS4=",
            "vw": timestamp,
            "ab": "",
            "lo": "auyuLHoaSEU=",
            "an": "7pMB/N4HgyQ=",
            "ns": "5iPMjjmsV2Q=",
            "sc": "HcjwEHO9nEE=",
            "nb": "8AgePD8d/y4=",
            "pi": random_uuidv4(),
            "as": "ZiEGW6ynU0Q=",
            "cf": url,
            "ca": random_uuidv4(),
            "qr": timestamp,

            "jf": "",
            "protocol": 102,
            "smid": _get_smid(),
            "time": 25,
            "version": "3.0.0",
        }
    
        data['py'] = hashlib.md5(''.join(
            [str(v * 0x2710) if isinstance(v, int) else v for v in data.values()]).encode()).hexdigest()
        
        res = {}

        for k in data:
            v = data[k]
            if not v in (None, '') and k in lookup:
                v = _des_encrypt(lookup[k], v)
            res[k] = v

        res = base64.b64encode(gzip.compress(json.dumps(res, separators=(',', ':')).encode()))
        uid = hashlib.md5(uuid.encode()).hexdigest()[:16]

        res = _aes_cbc_encrypt(res.decode(), uid)

        return res


def _aes_cbc_encrypt(data: str, key: str) -> str:
    #  they use abnormal rcon 
    RCON = [0, 1, 2, 4, 8, 16, 32, 64, 128, 27, 54]
    SBOX = (
        0x63, 0x7C, 0x77, 0x7B, 0xF2, 0x6B, 0x6F, 0xC5, 0x30, 0x01, 0x67, 0x2B, 0xFE, 0xD7, 0xAB, 0x76,
        0xCA, 0x82, 0xC9, 0x7D, 0xFA, 0x59, 0x47, 0xF0, 0xAD, 0xD4, 0xA2, 0xAF, 0x9C, 0xA4, 0x72, 0xC0,
        0xB7, 0xFD, 0x93, 0x26, 0x36, 0x3F, 0xF7, 0xCC, 0x34, 0xA5, 0xE5, 0xF1, 0x71, 0xD8, 0x31, 0x15,
        0x04, 0xC7, 0x23, 0xC3, 0x18, 0x96, 0x05, 0x9A, 0x07, 0x12, 0x80, 0xE2, 0xEB, 0x27, 0xB2, 0x75,
        0x09, 0x83, 0x2C, 0x1A, 0x1B, 0x6E, 0x5A, 0xA0, 0x52, 0x3B, 0xD6, 0xB3, 0x29, 0xE3, 0x2F, 0x84,
        0x53, 0xD1, 0x00, 0xED, 0x20, 0xFC, 0xB1, 0x5B, 0x6A, 0xCB, 0xBE, 0x39, 0x4A, 0x4C, 0x58, 0xCF,
        0xD0, 0xEF, 0xAA, 0xFB, 0x43, 0x4D, 0x33, 0x85, 0x45, 0xF9, 0x02, 0x7F, 0x50, 0x3C, 0x9F, 0xA8,
        0x51, 0xA3, 0x40, 0x8F, 0x92, 0x9D, 0x38, 0xF5, 0xBC, 0xB6, 0xDA, 0x21, 0x10, 0xFF, 0xF3, 0xD2,
        0xCD, 0x0C, 0x13, 0xEC, 0x5F, 0x97, 0x44, 0x17, 0xC4, 0xA7, 0x7E, 0x3D, 0x64, 0x5D, 0x19, 0x73,
        0x60, 0x81, 0x4F, 0xDC, 0x22, 0x2A, 0x90, 0x88, 0x46, 0xEE, 0xB8, 0x14, 0xDE, 0x5E, 0x0B, 0xDB,
        0xE0, 0x32, 0x3A, 0x0A, 0x49, 0x06, 0x24, 0x5C, 0xC2, 0xD3, 0xAC, 0x62, 0x91, 0x95, 0xE4, 0x79,
        0xE7, 0xC8, 0x37, 0x6D, 0x8D, 0xD5, 0x4E, 0xA9, 0x6C, 0x56, 0xF4, 0xEA, 0x65, 0x7A, 0xAE, 0x08,
        0xBA, 0x78, 0x25, 0x2E, 0x1C, 0xA6, 0xB4, 0xC6, 0xE8, 0xDD, 0x74, 0x1F, 0x4B, 0xBD, 0x8B, 0x8A,
        0x70, 0x3E, 0xB5, 0x66, 0x48, 0x03, 0xF6, 0x0E, 0x61, 0x35, 0x57, 0xB9, 0x86, 0xC1, 0x1D, 0x9E,
        0xE1, 0xF8, 0x98, 0x11, 0x69, 0xD9, 0x8E, 0x94, 0x9B, 0x1E, 0x87, 0xE9, 0xCE, 0x55, 0x28, 0xDF,
        0x8C, 0xA1, 0x89, 0x0D, 0xBF, 0xE6, 0x42, 0x68, 0x41, 0x99, 0x2D, 0x0F, 0xB0, 0x54, 0xBB, 0x16
    )
    T1 = [3328402341, 4168907908, 4000806809, 4135287693, 4294111757, 3597364157, 3731845041, 2445657428, 1613770832, 33620227, 3462883241, 1445669757, 3892248089, 3050821474, 1303096294, 3967186586, 2412431941, 528646813, 2311702848, 4202528135, 4026202645, 2992200171, 2387036105, 4226871307, 1101901292, 3017069671, 1604494077, 1169141738, 597466303, 1403299063, 3832705686, 2613100635, 1974974402, 3791519004, 1033081774, 1277568618, 1815492186, 2118074177, 4126668546, 2211236943, 1748251740, 1369810420, 3521504564, 4193382664, 3799085459, 2883115123, 1647391059, 706024767, 134480908, 2512897874, 1176707941, 2646852446, 806885416, 932615841, 168101135, 798661301, 235341577, 605164086, 461406363, 3756188221, 3454790438, 1311188841, 2142417613, 3933566367, 302582043, 495158174, 1479289972, 874125870, 907746093, 3698224818, 3025820398, 1537253627, 2756858614, 1983593293, 3084310113, 2108928974, 1378429307, 3722699582, 1580150641, 327451799, 2790478837, 3117535592, 0, 3253595436, 1075847264, 3825007647, 2041688520, 3059440621, 3563743934, 2378943302, 1740553945, 1916352843, 2487896798, 2555137236, 2958579944, 2244988746, 3151024235, 3320835882, 1336584933, 3992714006, 2252555205, 2588757463, 1714631509, 293963156, 2319795663, 3925473552, 67240454, 4269768577, 2689618160, 2017213508, 631218106, 1269344483, 2723238387, 1571005438, 2151694528, 93294474, 1066570413, 563977660, 1882732616, 4059428100, 1673313503, 2008463041, 2950355573, 1109467491, 537923632, 3858759450, 4260623118, 3218264685, 2177748300, 403442708, 638784309, 3287084079, 3193921505, 899127202, 2286175436, 773265209, 2479146071, 1437050866, 4236148354, 2050833735, 3362022572, 3126681063, 840505643, 3866325909, 3227541664, 427917720, 2655997905, 2749160575, 1143087718, 1412049534, 999329963, 193497219, 2353415882, 3354324521, 1807268051, 672404540, 2816401017, 3160301282, 369822493, 2916866934, 3688947771, 1681011286, 1949973070, 336202270, 2454276571, 201721354, 1210328172, 3093060836, 2680341085, 3184776046, 1135389935, 3294782118, 965841320, 831886756, 3554993207, 4068047243, 3588745010, 2345191491, 1849112409, 3664604599, 26054028, 2983581028, 2622377682, 1235855840, 3630984372, 2891339514, 4092916743, 3488279077, 3395642799, 4101667470, 1202630377, 268961816, 1874508501, 4034427016, 1243948399, 1546530418, 941366308, 1470539505, 1941222599, 2546386513, 3421038627, 2715671932, 3899946140, 1042226977, 2521517021, 1639824860, 227249030, 260737669, 3765465232, 2084453954, 1907733956, 3429263018, 2420656344, 100860677, 4160157185, 470683154, 3261161891, 1781871967, 2924959737, 1773779408, 394692241, 2579611992, 974986535, 664706745, 3655459128, 3958962195, 731420851, 571543859, 3530123707, 2849626480, 126783113, 865375399, 765172662, 1008606754, 361203602, 3387549984, 2278477385, 2857719295, 1344809080, 2782912378, 59542671, 1503764984, 160008576, 437062935, 1707065306, 3622233649, 2218934982, 3496503480, 2185314755, 697932208, 1512910199, 504303377, 2075177163, 2824099068, 1841019862, 739644986]
    T2 = [2781242211, 2230877308, 2582542199, 2381740923, 234877682, 3184946027, 2984144751, 1418839493, 1348481072, 50462977, 2848876391, 2102799147, 434634494, 1656084439, 3863849899, 2599188086, 1167051466, 2636087938, 1082771913, 2281340285, 368048890, 3954334041, 3381544775, 201060592, 3963727277, 1739838676, 4250903202, 3930435503, 3206782108, 4149453988, 2531553906, 1536934080, 3262494647, 484572669, 2923271059, 1783375398, 1517041206, 1098792767, 49674231, 1334037708, 1550332980, 4098991525, 886171109, 150598129, 2481090929, 1940642008, 1398944049, 1059722517, 201851908, 1385547719, 1699095331, 1587397571, 674240536, 2704774806, 252314885, 3039795866, 151914247, 908333586, 2602270848, 1038082786, 651029483, 1766729511, 3447698098, 2682942837, 454166793, 2652734339, 1951935532, 775166490, 758520603, 3000790638, 4004797018, 4217086112, 4137964114, 1299594043, 1639438038, 3464344499, 2068982057, 1054729187, 1901997871, 2534638724, 4121318227, 1757008337, 0, 750906861, 1614815264, 535035132, 3363418545, 3988151131, 3201591914, 1183697867, 3647454910, 1265776953, 3734260298, 3566750796, 3903871064, 1250283471, 1807470800, 717615087, 3847203498, 384695291, 3313910595, 3617213773, 1432761139, 2484176261, 3481945413, 283769337, 100925954, 2180939647, 4037038160, 1148730428, 3123027871, 3813386408, 4087501137, 4267549603, 3229630528, 2315620239, 2906624658, 3156319645, 1215313976, 82966005, 3747855548, 3245848246, 1974459098, 1665278241, 807407632, 451280895, 251524083, 1841287890, 1283575245, 337120268, 891687699, 801369324, 3787349855, 2721421207, 3431482436, 959321879, 1469301956, 4065699751, 2197585534, 1199193405, 2898814052, 3887750493, 724703513, 2514908019, 2696962144, 2551808385, 3516813135, 2141445340, 1715741218, 2119445034, 2872807568, 2198571144, 3398190662, 700968686, 3547052216, 1009259540, 2041044702, 3803995742, 487983883, 1991105499, 1004265696, 1449407026, 1316239930, 504629770, 3683797321, 168560134, 1816667172, 3837287516, 1570751170, 1857934291, 4014189740, 2797888098, 2822345105, 2754712981, 936633572, 2347923833, 852879335, 1133234376, 1500395319, 3084545389, 2348912013, 1689376213, 3533459022, 3762923945, 3034082412, 4205598294, 133428468, 634383082, 2949277029, 2398386810, 3913789102, 403703816, 3580869306, 2297460856, 1867130149, 1918643758, 607656988, 4049053350, 3346248884, 1368901318, 600565992, 2090982877, 2632479860, 557719327, 3717614411, 3697393085, 2249034635, 2232388234, 2430627952, 1115438654, 3295786421, 2865522278, 3633334344, 84280067, 33027830, 303828494, 2747425121, 1600795957, 4188952407, 3496589753, 2434238086, 1486471617, 658119965, 3106381470, 953803233, 334231800, 3005978776, 857870609, 3151128937, 1890179545, 2298973838, 2805175444, 3056442267, 574365214, 2450884487, 550103529, 1233637070, 4289353045, 2018519080, 2057691103, 2399374476, 4166623649, 2148108681, 387583245, 3664101311, 836232934, 3330556482, 3100665960, 3280093505, 2955516313, 2002398509, 287182607, 3413881008, 4238890068, 3597515707, 975967766]
    T3 = [1671808611, 2089089148, 2006576759, 2072901243, 4061003762, 1807603307, 1873927791, 3310653893, 810573872, 16974337, 1739181671, 729634347, 4263110654, 3613570519, 2883997099, 1989864566, 3393556426, 2191335298, 3376449993, 2106063485, 4195741690, 1508618841, 1204391495, 4027317232, 2917941677, 3563566036, 2734514082, 2951366063, 2629772188, 2767672228, 1922491506, 3227229120, 3082974647, 4246528509, 2477669779, 644500518, 911895606, 1061256767, 4144166391, 3427763148, 878471220, 2784252325, 3845444069, 4043897329, 1905517169, 3631459288, 827548209, 356461077, 67897348, 3344078279, 593839651, 3277757891, 405286936, 2527147926, 84871685, 2595565466, 118033927, 305538066, 2157648768, 3795705826, 3945188843, 661212711, 2999812018, 1973414517, 152769033, 2208177539, 745822252, 439235610, 455947803, 1857215598, 1525593178, 2700827552, 1391895634, 994932283, 3596728278, 3016654259, 695947817, 3812548067, 795958831, 2224493444, 1408607827, 3513301457, 0, 3979133421, 543178784, 4229948412, 2982705585, 1542305371, 1790891114, 3410398667, 3201918910, 961245753, 1256100938, 1289001036, 1491644504, 3477767631, 3496721360, 4012557807, 2867154858, 4212583931, 1137018435, 1305975373, 861234739, 2241073541, 1171229253, 4178635257, 33948674, 2139225727, 1357946960, 1011120188, 2679776671, 2833468328, 1374921297, 2751356323, 1086357568, 2408187279, 2460827538, 2646352285, 944271416, 4110742005, 3168756668, 3066132406, 3665145818, 560153121, 271589392, 4279952895, 4077846003, 3530407890, 3444343245, 202643468, 322250259, 3962553324, 1608629855, 2543990167, 1154254916, 389623319, 3294073796, 2817676711, 2122513534, 1028094525, 1689045092, 1575467613, 422261273, 1939203699, 1621147744, 2174228865, 1339137615, 3699352540, 577127458, 712922154, 2427141008, 2290289544, 1187679302, 3995715566, 3100863416, 339486740, 3732514782, 1591917662, 186455563, 3681988059, 3762019296, 844522546, 978220090, 169743370, 1239126601, 101321734, 611076132, 1558493276, 3260915650, 3547250131, 2901361580, 1655096418, 2443721105, 2510565781, 3828863972, 2039214713, 3878868455, 3359869896, 928607799, 1840765549, 2374762893, 3580146133, 1322425422, 2850048425, 1823791212, 1459268694, 4094161908, 3928346602, 1706019429, 2056189050, 2934523822, 135794696, 3134549946, 2022240376, 628050469, 779246638, 472135708, 2800834470, 3032970164, 3327236038, 3894660072, 3715932637, 1956440180, 522272287, 1272813131, 3185336765, 2340818315, 2323976074, 1888542832, 1044544574, 3049550261, 1722469478, 1222152264, 50660867, 4127324150, 236067854, 1638122081, 895445557, 1475980887, 3117443513, 2257655686, 3243809217, 489110045, 2662934430, 3778599393, 4162055160, 2561878936, 288563729, 1773916777, 3648039385, 2391345038, 2493985684, 2612407707, 505560094, 2274497927, 3911240169, 3460925390, 1442818645, 678973480, 3749357023, 2358182796, 2717407649, 2306869641, 219617805, 3218761151, 3862026214, 1120306242, 1756942440, 1103331905, 2578459033, 762796589, 252780047, 2966125488, 1425844308, 3151392187, 372911126]
    T4 = [1667474886, 2088535288, 2004326894, 2071694838, 4075949567, 1802223062, 1869591006, 3318043793, 808472672, 16843522, 1734846926, 724270422, 4278065639, 3621216949, 2880169549, 1987484396, 3402253711, 2189597983, 3385409673, 2105378810, 4210693615, 1499065266, 1195886990, 4042263547, 2913856577, 3570689971, 2728590687, 2947541573, 2627518243, 2762274643, 1920112356, 3233831835, 3082273397, 4261223649, 2475929149, 640051788, 909531756, 1061110142, 4160160501, 3435941763, 875846760, 2779116625, 3857003729, 4059105529, 1903268834, 3638064043, 825316194, 353713962, 67374088, 3351728789, 589522246, 3284360861, 404236336, 2526454071, 84217610, 2593830191, 117901582, 303183396, 2155911963, 3806477791, 3958056653, 656894286, 2998062463, 1970642922, 151591698, 2206440989, 741110872, 437923380, 454765878, 1852748508, 1515908788, 2694904667, 1381168804, 993742198, 3604373943, 3014905469, 690584402, 3823320797, 791638366, 2223281939, 1398011302, 3520161977, 0, 3991743681, 538992704, 4244381667, 2981218425, 1532751286, 1785380564, 3419096717, 3200178535, 960056178, 1246420628, 1280103576, 1482221744, 3486468741, 3503319995, 4025428677, 2863326543, 4227536621, 1128514950, 1296947098, 859002214, 2240123921, 1162203018, 4193849577, 33687044, 2139062782, 1347481760, 1010582648, 2678045221, 2829640523, 1364325282, 2745433693, 1077985408, 2408548869, 2459086143, 2644360225, 943212656, 4126475505, 3166494563, 3065430391, 3671750063, 555836226, 269496352, 4294908645, 4092792573, 3537006015, 3452783745, 202118168, 320025894, 3974901699, 1600119230, 2543297077, 1145359496, 387397934, 3301201811, 2812801621, 2122220284, 1027426170, 1684319432, 1566435258, 421079858, 1936954854, 1616945344, 2172753945, 1330631070, 3705438115, 572679748, 707427924, 2425400123, 2290647819, 1179044492, 4008585671, 3099120491, 336870440, 3739122087, 1583276732, 185277718, 3688593069, 3772791771, 842159716, 976899700, 168435220, 1229577106, 101059084, 606366792, 1549591736, 3267517855, 3553849021, 2897014595, 1650632388, 2442242105, 2509612081, 3840161747, 2038008818, 3890688725, 3368567691, 926374254, 1835907034, 2374863873, 3587531953, 1313788572, 2846482505, 1819063512, 1448540844, 4109633523, 3941213647, 1701162954, 2054852340, 2930698567, 134748176, 3132806511, 2021165296, 623210314, 774795868, 471606328, 2795958615, 3031746419, 3334885783, 3907527627, 3722280097, 1953799400, 522133822, 1263263126, 3183336545, 2341176845, 2324333839, 1886425312, 1044267644, 3048588401, 1718004428, 1212733584, 50529542, 4143317495, 235803164, 1633788866, 892690282, 1465383342, 3115962473, 2256965911, 3250673817, 488449850, 2661202215, 3789633753, 4177007595, 2560144171, 286339874, 1768537042, 3654906025, 2391705863, 2492770099, 2610673197, 505291324, 2273808917, 3924369609, 3469625735, 1431699370, 673740880, 3755965093, 2358021891, 2711746649, 2307489801, 218961690, 3217021541, 3873845719, 1111672452, 1751693520, 1094828930, 2576986153, 757954394, 252645662, 2964376443, 1414855848, 3149649517, 370555436]
        
    def key_expansion(key) -> list[44]:
        res = key + [0] * 40
        for n in range(4, 44):
            block = res[n - 1]
            if (n % 4 == 0):
                block = (block & 0xffffff) << 8 | block >> 24
                block = (
                    SBOX[block >> 24] << 24 | 
                    SBOX[block >> 16 & 0xff] << 16 | 
                    SBOX[block >> 8 & 0xff] << 8 | 
                    SBOX[0xff & block]
                )
                block ^= RCON[n // 4] << 24
            res[n] = block ^ res[n - 4]

        return res
    
    def stoa(s):
        s = s.encode('utf-8').decode('latin-1')
        r = []

        for n in range(len(s)):
            i = n >> 2
            if i >= len(r):
                r.append(0)

            r[i] |= (ord(s[n]) & 0xFF) << (24 - (n % 4) * 8)
            
        return r, len(s)
    
    data = stoa(data)[0]
    data += [0] * (4 - (len(data) % 4 or 4))
    key = key_expansion(stoa(key)[0])

    result = ""

    prev = [808529970, 808661044, 808792118, 808923192]
    for cur in range(0, len(data), 4):
        tmp = data[cur: cur + 4]
        s = [0, 0, 0, 0]
        ptr = 4
        for i in range(4):
            s[i] = tmp[i] ^ prev[i] ^ key[i]
        for _ in range(9):
            t1 = T1[s[0] >> 24] ^ T2[(s[1] >> 16) & 0xff] ^ T3[(s[2] >> 8) & 0xff] ^ T4[s[3] & 0xff] ^ key[ptr]
            t2 = T1[s[1] >> 24] ^ T2[(s[2] >> 16) & 0xff] ^ T3[(s[3] >> 8) & 0xff] ^ T4[s[0] & 0xff] ^ key[ptr + 1]
            t3 = T1[s[2] >> 24] ^ T2[(s[3] >> 16) & 0xff] ^ T3[(s[0] >> 8) & 0xff] ^ T4[s[1] & 0xff] ^ key[ptr + 2]
            t4 = T1[s[3] >> 24] ^ T2[(s[0] >> 16) & 0xff] ^ T3[(s[1] >> 8) & 0xff] ^ T4[s[2] & 0xff] ^ key[ptr + 3]
            ptr += 4
            s = [t1, t2, t3, t4]
        t1 = (SBOX[s[0] >> 24] << 24 | SBOX[s[1] >> 16 & 0xff] << 16 | SBOX[s[2] >> 8 & 0xff] << 8 | SBOX[0xff & s[3]]) ^ key[ptr]
        t2 = (SBOX[s[1] >> 24] << 24 | SBOX[s[2] >> 16 & 0xff] << 16 | SBOX[s[3] >> 8 & 0xff] << 8 | SBOX[0xff & s[0]]) ^ key[ptr + 1]
        t3 = (SBOX[s[2] >> 24] << 24 | SBOX[s[3] >> 16 & 0xff] << 16 | SBOX[s[0] >> 8 & 0xff] << 8 | SBOX[0xff & s[1]]) ^ key[ptr + 2]
        t4 = (SBOX[s[3] >> 24] << 24 | SBOX[s[0] >> 16 & 0xff] << 16 | SBOX[s[1] >> 8 & 0xff] << 8 | SBOX[0xff & s[2]]) ^ key[ptr + 3]
        prev = [t1, t2, t3, t4]
        for num in prev:
            result += f'{num:08x}'
   
    return result
